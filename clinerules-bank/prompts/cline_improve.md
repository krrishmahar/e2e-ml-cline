Improve code: readability, deduplication, performance, architecture. Return code only.
